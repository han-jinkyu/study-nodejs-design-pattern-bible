# 2. 관찰자 패턴

- 관찰자 패턴은 상태 변화가 일어날 때 관찰자에서 통지할 수 있는 객체를 정의하는 것이다.
- 콜백 패턴은 오직 하나의 리스너에게 결과를 전달하는 반편, 관찰자 패턴은 주체가 여러 관찰자에게 통지할 수 있다는 점이 있다.

## 2.1 EventEmitter 클래스

- 관찰자 패턴은 이미 코어에 내장되어 있으며, EventEmitter 클래스를 통해 사용 가능하다.

```js
import { EventEmitter } from  'events'
const emitter = new EventEmitter()
```

- EventEmitter의 필수 메서드는 다음과 같다.
    - on(event, listenter): 주어진 이벤트 유형에 대해 새로운 리스너를 등록한다.
    - once(event, listener): 첫 이벤트가 전달된 후 제거되는 새로운 리스너를 등록한다.
    - emit(event, args...): 새 이벤트를 생성하고 리스너에게 전달한 추가 인자를 제공한다.
    - removeListener(event, listener): 지정된 이벤트 유형에 대한 리스너를 제거한다.
- 모든 메서드는 chaining이 가능하도록 EventEmitter 인스턴스를 반환한다.
- 첫 번째 인자가 꼭 에러일 필요는 없다.

## 2.2 EventEmitter 생성 및 사용

- 다음 코드는 EventEmitter를 사용해 파일 목록에서 특정 패턴이 발견되면 실시간으로 구독자에게 통지하는 함수다.

```js
import { EventEmitter } from 'events'
import { readFile } from 'fs'

function findRegex(files, regex) {
    const emitter = new EventEmitter()
    for (const file of files) {
        readFile(file, 'utf8', (err, content) => {
            if (err) {
                return emitter.emit('error', err)
            }

            emitter.emit('fileread', file)
            const match = content.match(regex)
            if (match) {
                match.forEach(elem => emitter.emit('found', file, elem))
            }
        })
    }
    return emitter
}
```

- 위 함수는 3가지 이벤트를 발생시키는 EventEmitter 인스턴스를 반환한다.
    - fileread, 파일을 읽을 때
    - found, 일치하는 항목이 발견되었을 때
    - error, 파일을 읽는 동안 에러가 발생하였을 때

```js
findRegex(
    ['fileA.txt', 'fileB.json'],
    /hello \w+/g
)
    .on('fileread', file => console.log(`${file} was read`))
    .on('found', (file, match) => console.log(`Matched "${match}" in ${file}`))
    .on('error', err => console.error(`Error emitted ${err.message}`))
```

-----
[HOME](./index.md)
