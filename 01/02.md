# 2. Node.js는 어떻게 동작하는가

## 2.1 I/O는 느리다

- I/O는 컴퓨터의 기본적인 동작 중 가장 느리다.
- RAM에 접근하는 것은 나노초, 디스크와 네트워크는 밀리초가 걸린다.
- CPU 측면에선 보내지는 요청과 작업이 완료되는 순간 사이에 지연이 발생한다.

## 2.2 블로킹 I/O

- 전통적인 블로킹 I/O 프로그래밍에선 I/O를 요청하는 함수의 호출은 작업이 완료될 때까지 스레드의 실행을 차단한다.
- 블로킹 I/O를 사용하여 구현한 웹 서버는 같은 스레드 내에서 여러 연결을 처리하지 못한다.
- 이 문제를 해결하기 위해 개별의 스레드나 프로세스를 사용한다.
- 하지만 이에도 불구하고 스레드 혹은 프로세스 당 유휴 시간이 발생한다.
- 메모리를 소모하고 컨텍스트 전환을 유발하여 귀중한 메모리와 CPU 사이클을 낭비한다.

## 2.3 논 블로킹 I/O

- 대부분의 최신 운영체제는 논 블로킹 I/O를 지원한다.
- 이 운영모드에선 데이터가 읽히거나 쓰여지기를 기다리지 않고 항상 즉시 반환한다.
- 호출 순간에 사용 가능한 결과가 없는 경우, 미리 정의된 상수를 반환하여 그 순간에 사용 가능한 데이터가 없다는 것을 알린다.
- 논 블로킹 I/O를 다루는 가장 기본적인 패턴은 데이터가 반환될 때까지 폴링하는 것이다. (= 바쁜 대기)

## 2.4 이벤트 디멀티플렉싱

- 대부분의 운영체제는 논 블로킹 리소스를 효율적으로 처리하기 위해, **동기 이벤트 디멀티플렉서** 또는 **이벤트 통지 인터페이스**라는 메커니즘을 이용한다.
- 멀티플렉싱은 여러 신호를 하나로 합성하는 것, 디멀티플렉싱은 다시 분할하는 것이다.
- 동기 이벤트 디멀티플렉서는 여러 리소스를 관찰하고 연산이 완료되면 새로운 이벤트를 반환한다.
- 디멀티플렉서를 이용해서 다음과 같이 처리할 수 있다.
    1. 디멀티플렉서가 관찰될 리소스 그룹과 함께 설정된다.
    2. 디멀티플렉서가 읽을 준비가 된 리소스가 있을 때까지 블로킹된다.
    3. 준비된 리소스가 있으면 이벤트 세트를 반환한다.
    4. 반환된 이벤트가 각각 처리된다.
    5. 다시 읽을 준비가 된 리소스가 있을 때까지 디멀티플렉서가 블로킹된다.
- 이를 이벤트 루프라 한다.
- 위를 이용하면 단일 스레드 내에서 여러 I/O 작업을 다룰 수 있게 된다.
- 이는 전체적인 유휴 시간을 최소화하는 것에 이점이 있다.
- 또한 경쟁 상태 발생 문제나 다중 스레드의 동기화 문제가 없다는 장점이 있다.

## 2.5 리액터(Reactor) 패턴

- 리액터 패턴의 주요 아이디어는 **각 I/O 작업에 연관된 핸들러를 갖는다는 것**이다.
- Node.js에서의 핸들러는 콜백 함수에 해당한다.
- 이 핸들러는 이벤트가 이벤트 루프에 의해 처리되는 즉시 호출된다.
- 리액터 패턴을 사용하는 애플리케이션은 다음과 같이 동작한다.
    1. 이벤트 디멀티플렉서에 요청을 전달하여 새로운 I/O 작업을 생성한다.
        - 작업이 완료될 때 호출할 핸들러도 전달
        - 새로운 요청 전달은 논 블로킹 호출이며, 제어권은 애플리케이션으로 즉시 반환된다.
    2. 이벤트 디멀티플렉서는 I/O 작업이 완료된 이벤트를 이벤트 큐로 전달한다.
    3. 이벤트 루프가 이벤트 큐의 항목을 순환한다.
    4. 각 이벤트 관련 핸들러가 호출된다.
    5. 핸들러의 실행이 완료되면 제어권을 이벤트 루프에 반환한다.
    6. 이벤트 큐의 모든 항목이 처리되면 이벤트 루프는 이벤트 디멀티플렉서에서 블로킹된다.
- Reactor 패턴: 관찰 대상 리소스에서 새 이벤트를 사용할 수 있을 때까지 블로킹하여 I/O를 처리하고, 각 이벤트를 관련된 핸들러에 전달한다.

## 2.6 Libuv, Node.js의 I/O 엔진

- 각 운영체제는 이벤트 디멀티플렉서를 위한 자체 인터페이스를 가진다.
- 하지만 각각 동작 방식이 다르므로, 이런 논 블로킹 동작을 표준화하기 위해 `libuv`라고 불리는 C 라이브러리를 만들었다.
- `libuv`는 이외에도 리액터 패턴을 구현하고 있다.

## 2.7 Node.js를 위한 구성

- 리액터 패턴과 `libuv`는 Node.js의 기본 구성 요소지만 전체 플랫폼의 구축을 위해 3개의 구성이 더 필요하다.
    1. libuv와 다른 저수준 기능을 랩핑하고 표출하기 위한 바인딩 세트
    2. V8 엔진
    3. 고수준 Node.js API를 구현하고 있는 코어 JavaScript 라이브러리

-----
[HOME](./index.md)
